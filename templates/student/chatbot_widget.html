<!-- Chatbot Widget - Include this in all student pages -->
<style>
    #chatbot-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }

    #chatbot-button {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        transition: all 0.3s ease;
    }

    #chatbot-button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    #chatbot-window {
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 380px;
        height: 500px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        display: none;
        flex-direction: column;
        overflow: hidden;
    }

    #chatbot-window.open {
        display: flex;
    }

    #chatbot-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #chatbot-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        background: #f9fafb;
    }

    .chat-message {
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
    }

    .chat-message.user {
        align-items: flex-end;
    }

    .chat-message.assistant {
        align-items: flex-start;
    }

    .message-bubble {
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 12px;
        word-wrap: break-word;
    }

    .chat-message.user .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .chat-message.assistant .message-bubble {
        background: white;
        color: #1f2937;
        border: 1px solid #e5e7eb;
    }

    .message-time {
        font-size: 10px;
        color: #9ca3af;
        margin-top: 4px;
    }

    #chatbot-input-area {
        padding: 12px;
        border-top: 1px solid #e5e7eb;
        background: white;
        display: flex;
        gap: 8px;
    }

    #chatbot-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        outline: none;
        font-size: 14px;
    }

    #chatbot-input:focus {
        border-color: #667eea;
    }

    #chatbot-send {
        padding: 10px 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    #chatbot-send:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    #chatbot-send:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 10px 14px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        width: fit-content;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #9ca3af;
        animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-10px);
        }
    }
</style>

<div id="chatbot-widget">
    <!-- Chatbot Button -->
    <button id="chatbot-button" onclick="toggleChatbot()">
        ðŸ’¬
    </button>

    <!-- Chatbot Window -->
    <div id="chatbot-window">
        <!-- Header -->
        <div id="chatbot-header">
            <div>
                <h3 class="font-bold text-lg">Learning Assistant</h3>
                <p class="text-xs opacity-90">I'm here to guide you!</p>
            </div>
            <button onclick="toggleChatbot()" class="text-white hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Messages -->
        <div id="chatbot-messages">
            <div class="chat-message assistant">
                <div class="message-bubble">
                    ðŸ‘‹ Hi! I'm your learning assistant. I can help you understand concepts, but I won't give you direct answers. Ask me anything!
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div id="chatbot-input-area">
            <input type="text" 
                   id="chatbot-input" 
                   placeholder="Ask me anything..." 
                   onkeypress="handleChatKeyPress(event)">
            <button id="chatbot-send" onclick="sendChatMessage()">Send</button>
        </div>
    </div>
</div>

<script>
    let chatbotOpen = false;
    const studentId = "{{ student_id }}";
    const currentTopic = "{{ topic_name if topic_name is defined else '' }}";
    const currentConcept = "{{ concept_name if concept_name is defined else '' }}";

    function toggleChatbot() {
        chatbotOpen = !chatbotOpen;
        const window = document.getElementById('chatbot-window');
        if (chatbotOpen) {
            window.classList.add('open');
            document.getElementById('chatbot-input').focus();
        } else {
            window.classList.remove('open');
        }
    }

    function handleChatKeyPress(event) {
        if (event.key === 'Enter') {
            sendChatMessage();
        }
    }

    async function sendChatMessage() {
        const input = document.getElementById('chatbot-input');
        const message = input.value.trim();
        
        if (!message) return;

        // Clear input
        input.value = '';

        // Add user message to chat
        addChatMessage('user', message);

        // Show typing indicator
        showTypingIndicator();

        // Prepare context
        const context = {
            topic: currentTopic,
            concept: currentConcept,
            page: window.location.pathname
        };

        try {
            const response = await fetch(`/student/${studentId}/learn/api/chatbot/message`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    context: context
                })
            });

            const data = await response.json();

            // Remove typing indicator
            removeTypingIndicator();

            if (data.message) {
                addChatMessage('assistant', data.message);
            } else {
                addChatMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            }
        } catch (error) {
            console.error('Chatbot error:', error);
            removeTypingIndicator();
            addChatMessage('assistant', 'Sorry, I\'m having trouble connecting. Please try again later.');
        }
    }

    function addChatMessage(role, message) {
        const messagesDiv = document.getElementById('chatbot-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}`;
        
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        
        messageDiv.innerHTML = `
            <div class="message-bubble">${escapeHtml(message)}</div>
            <div class="message-time">${timeStr}</div>
        `;
        
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showTypingIndicator() {
        const messagesDiv = document.getElementById('chatbot-messages');
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.className = 'chat-message assistant';
        typingDiv.innerHTML = `
            <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        `;
        messagesDiv.appendChild(typingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function removeTypingIndicator() {
        const typingDiv = document.getElementById('typing-indicator');
        if (typingDiv) {
            typingDiv.remove();
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>

